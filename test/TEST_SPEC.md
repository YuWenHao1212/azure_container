# Azure Container API 測試規格文檔

## 文檔資訊
- **版本**: 2.2.0
- **建立日期**: 2025-07-30
- **最後更新**: 2025-08-01
- **維護者**: 測試團隊

## 變更歷史
| 版本 | 日期 | 變更內容 | 修改者 |
|------|------|----------|--------|
| 1.0.0 | 2025-07-30 | 初始版本 | 測試團隊 |
| 1.0.1 | 2025-07-30 | 修正格式問題 | 測試團隊 |
| 2.0.0 | 2025-07-31 | 完整整合所有測試案例規格（91個測試案例） | 測試團隊 |
| 2.1.0 | 2025-07-31 | 更新整合測試狀態，標記健康檢查和 Azure OpenAI 整合測試為已完成 | 測試團隊 |
| 2.2.0 | 2025-08-01 | 新增 LLM Factory 部署映射測試模組（8個測試案例 SVC-LLM-501~508），總測試案例數提升至110個 | 測試團隊 |

## 1. 測試案例編號系統

### 1.1 編號格式
```
[類別]-[模組]-[序號]-[類型]

範例: API-KW-001-UT
```

### 1.2 編號說明
| 代碼 | 類別 | 說明 | 編號範圍 |
|------|------|------|----------|
| **類別** |
| API | API 端點 | API 相關測試 | - |
| SVC | Service | 服務層測試 | - |
| UTL | Utility | 工具函數測試 | - |
| INT | Integration | 整合測試 | - |
| **模組** |
| HLT | Health | 健康檢查 | 001-099 |
| KW | Keywords | 關鍵字提取 | 100-199 |
| IDX | Index | 匹配指數 | 200-299 |
| GAP | Gap Analysis | 差距分析 | 300-399 |
| FMT | Format | 履歷格式化 | 400-499 |
| TLR | Tailor | 履歷客製化 | 500-599 |
| CRS | Course | 課程搜尋 | 600-699 |
| AUTH | Auth | 認證授權 | 700-799 |
| MON | Monitor | 監控除錯 | 800-899 |
| LLM | LLM Factory | LLM 工廠服務 | 501-599 |
| - | Reserved | 預留擴充 | 900-999 |
| **類型** |
| UT | Unit Test | 單元測試 | - |
| IT | Integration | 整合測試 | - |
| PT | Performance | 效能測試 | - |
| ST | Security | 安全測試 | - |

## 2. 測試案例模板

### 2.1 基本資訊

測試案例應包含以下資訊：

**標題格式**：`## 測試案例: [編號]`

**必要欄位**：
- 名稱：測試案例名稱
- 優先級：P0/P1/P2
- 類型：單元/整合/效能/安全
- 需求編號：REQ-XXX (對應需求文檔)
- 建立日期：YYYY-MM-DD
- 最後更新：YYYY-MM-DD

**測試內容**：
- 測試目標：簡述此測試要驗證的功能或情境
- 前置條件：列出所有必要的環境或資料準備
- 測試資料：輸入資料和預期輸出（YAML 格式）
- 測試步驟：詳細的執行步驟
- 預期結果：具體的驗證點
- 實際結果：執行後填寫
- 備註：任何額外說明

### 2.2 測試資料範例

```yaml
input:
  key1: value1
  key2: value2
expected:
  status: 200
  response: 
    success: true
    data: {...}
```

## 3. 現有測試案例

### 3.1 健康檢查模組 (HLT) - 10個測試案例

#### API-HLT-001-UT: 基本健康檢查
- **名稱**: 健康檢查端點正常回應
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-001
- **測試目標**: 驗證 /health 端點返回正確狀態

#### API-HLT-002-UT: 回應格式驗證
- **名稱**: 健康檢查回應格式正確性
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-001
- **測試目標**: 驗證回應包含所有必要欄位（status, timestamp, version, environment）

#### API-HLT-003-UT: 版本資訊正確性
- **名稱**: 健康檢查版本與設定一致
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-001
- **測試目標**: 驗證版本號與 settings.VERSION 一致

#### API-HLT-004-UT: 總是回傳健康狀態
- **名稱**: 健康檢查總是返回 healthy 狀態
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-001
- **測試目標**: 驗證無論系統狀態如何都返回 healthy

#### API-HLT-005-UT: 時間戳記格式驗證
- **名稱**: 健康檢查時間戳記為 ISO 格式
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-001
- **測試目標**: 驗證 timestamp 符合 ISO 8601 格式

#### API-HLT-006-UT: HTTP 方法驗證
- **名稱**: 健康檢查只接受 GET 方法
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-001
- **測試目標**: 驗證非 GET 方法返回 405 Method Not Allowed

#### API-HLT-007-UT: 不需要認證
- **名稱**: 健康檢查不需要認證
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-001
- **測試目標**: 驗證不帶認證資訊也能正常訪問

#### API-HLT-008-UT: CORS headers 存在
- **名稱**: 健康檢查包含 CORS headers
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-001
- **測試目標**: 驗證回應包含適當的 CORS headers

#### API-HLT-009-UT: Mock 時間戳記測試
- **名稱**: 健康檢查時間戳記可 Mock
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-001
- **測試目標**: 驗證時間戳記可被 Mock 以利測試

#### API-HLT-010-IT: 健康檢查整合測試 【已實作】
- **名稱**: 健康檢查含依賴服務狀態
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-001
- **測試目標**: 驗證健康檢查能正確反映外部服務狀態
- **狀態**: ✅ 已實作

### 3.2 關鍵字提取模組 (KW) - 基礎功能測試 (11個)

#### API-KW-101-UT: 基本關鍵字提取
- **名稱**: JD 關鍵字提取正常流程
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證能從職缺描述提取技能關鍵字

#### API-KW-102-UT: 驗證錯誤處理（描述過短）
- **名稱**: 短 JD 輸入錯誤處理
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證少於 200 字元的輸入返回適當錯誤

#### API-KW-103-UT: 無效的 max_keywords 參數
- **名稱**: 無效 max_keywords 參數處理
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 max_keywords < 1 或 > 50 時返回錯誤

#### API-KW-104-UT: Azure OpenAI 速率限制錯誤處理
- **名稱**: 處理 Azure OpenAI 速率限制
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證速率限制錯誤返回適當的 503 錯誤

#### API-KW-105-UT: 逾時錯誤處理
- **名稱**: 處理 API 逾時
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證逾時返回 504 Gateway Timeout

#### API-KW-106-UT: 品質警告偵測
- **名稱**: 關鍵字品質警告
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證低品質關鍵字時返回警告訊息

#### API-KW-107-UT: 回應格式驗證
- **名稱**: 關鍵字提取回應格式
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證回應包含所有必要欄位

#### API-KW-108-UT: 中文職缺描述支援
- **名稱**: 支援繁體中文 JD
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證繁體中文 JD 能正確處理

#### API-KW-109-UT: 錯誤時的服務清理
- **名稱**: 服務清理機制
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證錯誤發生時正確清理服務資源

#### API-KW-110-UT: 長職缺描述的邊界案例
- **名稱**: 處理超長 JD
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 8000 字元 JD 的處理

#### API-KW-111-IT: Azure OpenAI 整合 【已實作】
- **名稱**: 關鍵字提取 API 整合測試
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: 驗證與 Azure OpenAI 的整合
- **狀態**: ✅ 已實作

### 3.3 語言檢測功能測試 (29個單元測試，其中3個標記為無需測試)

#### API-KW-211-UT: 純英文語言檢測
- **名稱**: 驗證純英文內容正確檢測為 "en"
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 確保英文 JD 被正確識別並選擇英文 prompt

#### API-KW-212-UT: 純繁體中文語言檢測
- **名稱**: 驗證純繁體中文內容正確檢測為 "zh-TW"
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: language="zh-TW", confidence >= 0.5

#### API-KW-213-UT: 中英混合（繁中>20%）
- **名稱**: 混合語言繁中超過 20% 時檢測為 zh-TW
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 20% 繁體中文閾值規則正確執行

#### API-KW-214-UT: 中英混合（繁中<20%）
- **名稱**: 混合語言繁中少於 20% 時檢測為 en
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證混合內容中繁中少於 20% 時檢測為 en

#### API-KW-215-UT: 正好 20% 繁中閾值測試
- **名稱**: 驗證邊界條件（正好 20% 繁中）
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: language="zh-TW"（含邊界）

#### API-KW-216-UT: 拒絕簡體中文
- **名稱**: 簡體中文被正確拒絕
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 返回 HTTP 400 + UNSUPPORTED_LANGUAGE 錯誤

#### API-KW-217-UT: 拒絕日文
- **名稱**: 日文被正確拒絕
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 返回 HTTP 400 + UNSUPPORTED_LANGUAGE 錯誤

#### API-KW-218-UT: 拒絕韓文
- **名稱**: 韓文被正確拒絕
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 返回 HTTP 400 + UNSUPPORTED_LANGUAGE 錯誤

#### API-KW-219-UT: 拒絕西班牙文
- **名稱**: 西班牙文被正確拒絕
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 返回 HTTP 400 + UNSUPPORTED_LANGUAGE 錯誤

#### API-KW-220-UT: 拒絕混合不支援語言
- **名稱**: 混合多種不支援語言被正確拒絕
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 返回 HTTP 400 + UNSUPPORTED_LANGUAGE 錯誤

#### API-KW-221-UT: 文字過短錯誤
- **名稱**: 文字長度不足時的錯誤處理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: ValueError, "Text too short for reliable detection"

#### API-KW-222-UT: 空白文字錯誤
- **名稱**: 空白或純空格文字的錯誤處理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: ValueError, "Empty or whitespace-only text"

#### API-KW-223-UT: 低信心度檢測 【無需測】
- **名稱**: 低信心度語言檢測的處理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 回傳預設語言 "en" 並標記低信心度
- **狀態**: ❌ 無需測試
- **理由**: RuleBasedDetector 總是返回高信心度（0.90），不存在低信心度情況

#### API-KW-224-UT: 語言組成分析
- **名稱**: 內部語言組成分析邏輯
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: analyze_language_mix() 方法正確計算各語言比例

#### API-KW-225-UT: 日文中文字符處理
- **名稱**: 日文中包含中文字符的檢測
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 正確識別為日文而非中文

#### API-KW-226-UT: 模糊情況優先繁中 【無需測】
- **名稱**: 模糊情況下優先選擇繁體中文
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 在不確定情況下優先返回 zh-TW
- **狀態**: ❌ 無需測試
- **理由**: RuleBasedDetector 使用確定性規則（20%閾值），不存在模糊或不確定的情況

#### API-KW-227-UT: 精確20%閾值測試
- **名稱**: 正好 20% 繁中的精確測試
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證邊界條件處理正確

#### API-KW-228-UT: 低於20%閾值測試
- **名稱**: 剛好低於 20% 閾值的測試
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 19.9% 繁中時檢測為 en

#### API-KW-229-UT: 數字符號處理
- **名稱**: 純數字和符號的語言檢測
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 數字符號內容預設為 en

#### API-KW-230-UT: 混合內容數字符號
- **名稱**: 混合內容中的數字符號處理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 正確計算語言比例時排除數字符號

#### API-KW-231-UT: 服務清理測試 【無需測】
- **名稱**: 檢測服務資源清理
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 確保服務正確清理資源
- **狀態**: ❌ 無需測試
- **理由**: RuleBasedDetector 是完全無狀態的純函數實現，無需清理任何資源

#### API-KW-232-UT: 初始化和常數驗證
- **名稱**: 檢測器初始化和常數設定
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證檢測器正確初始化

#### API-KW-233-UT: 多次檢測一致性
- **名稱**: 多次檢測結果一致性
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 相同輸入多次檢測結果一致

#### API-KW-234-UT: 簡中語言組成分析
- **名稱**: 包含簡體中文的語言組成分析
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 正確識別簡體中文比例

#### API-KW-235-UT: 混合語言組成分析
- **名稱**: 混合語言的詳細組成分析
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 準確分析各語言成分比例

#### API-KW-236-UT: 空白文字處理
- **名稱**: 純空白字元的處理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 正確處理空白字元

#### API-KW-237-UT: 分析空文字
- **名稱**: 分析空文字的語言組成
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證空文字分析返回空結果

#### API-KW-238-UT: 檢測器初始化常數
- **名稱**: 檢測器初始化和常數驗證
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證檢測器的初始化設定和常數值

#### API-KW-239-UT: 多次檢測一致性
- **名稱**: 相同輸入多次檢測結果一致性
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證相同文字多次檢測結果保持一致

### 3.4 Prompt 管理器測試 (24個單元測試)

#### API-KW-241-UT: 英文 prompt 選擇驗證
- **名稱**: 檢測為英文時選擇英文 prompt
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 確認 prompt_manager.get_prompt("en", "latest") 被呼叫

#### API-KW-242-UT: 繁中 prompt 選擇驗證
- **名稱**: 檢測為繁中時選擇繁中 prompt
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: prompt_manager.get_prompt("zh-TW", "latest") 被呼叫

#### API-KW-243-UT: 混合語言 prompt 選擇
- **名稱**: 混合語言時根據閾值選擇正確 prompt
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 繁中比例 > 20% 時選擇 zh-TW prompt

#### API-KW-244-UT: 不支援語言錯誤處理
- **名稱**: prompt 管理器處理不支援語言
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: PromptNotAvailableError

#### API-KW-245-UT: 明確語言參數覆蓋
- **名稱**: language 參數可覆蓋自動檢測
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 使用指定語言 prompt，不呼叫檢測服務

#### API-KW-246-UT: 無效語言參數
- **名稱**: 無效語言參數的錯誤處理
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: ValueError

#### API-KW-247-UT: Prompt 格式驗證
- **名稱**: prompt 格式正確性
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: prompt 包含必要的 placeholders 和結構

#### API-KW-248-UT: 多重 placeholder 格式
- **名稱**: prompt 多重 placeholder 驗證
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 支援多個 placeholder 的格式化

#### API-KW-249-UT: 快取功能測試
- **名稱**: prompt 快取機制
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證快取正確運作

#### API-KW-250-UT: 可用版本查詢
- **名稱**: 獲取可用 prompt 版本
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 正確返回所有可用版本

#### API-KW-251-UT: 最新版本查詢
- **名稱**: 獲取最新 prompt 版本
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 正確識別最新版本

#### API-KW-252-UT: Prompt 元資料查詢
- **名稱**: prompt 元資料檢索
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 返回完整的 prompt 元資料

#### API-KW-253-UT: 支援組合查詢
- **名稱**: 獲取所有支援的語言版本組合
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 列出所有有效的語言版本組合

#### API-KW-254-UT: 快取統計
- **名稱**: prompt 快取統計資訊
- **優先級**: P2
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 提供快取命中率等統計

#### API-KW-255-UT: 混合內容超閾值 prompt
- **名稱**: 混合內容超過閾值時的 prompt 選擇
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: > 20% 繁中時選擇 zh-TW

#### API-KW-256-UT: 混合內容低閾值 prompt
- **名稱**: 混合內容低於閾值時的 prompt 選擇
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: < 20% 繁中時選擇 en

#### API-KW-257-UT: 20%閾值邊界處理
- **名稱**: 正好 20% 閾值的 prompt 選擇
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: = 20% 時選擇 zh-TW

#### API-KW-258-UT: 版本不存在降級
- **名稱**: 請求版本不存在時的降級處理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 自動降級到最新可用版本

#### API-KW-259-UT: Prompt 管理器初始化
- **名稱**: prompt 管理器初始化驗證
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 正確載入所有 prompt 設定

#### API-KW-260-UT: 資源清理
- **名稱**: prompt 管理器資源清理
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 確保資源正確釋放

#### API-KW-261-UT: 語言覆蓋工作流程
- **名稱**: 完整的語言覆蓋工作流程
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 端到端驗證語言覆蓋邏輯

#### API-KW-262-UT: 不支援語言鏈
- **名稱**: 不支援語言的錯誤傳遞鏈
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 錯誤正確傳遞到上層

#### API-KW-263-UT: JD 格式化測試
- **名稱**: 使用 JD 格式化 prompt
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: JD 正確插入 prompt 模板

#### API-KW-264-UT: Prompt 模板邊界案例
- **名稱**: prompt 模板驗證邊界案例
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 處理特殊字元和邊界情況

### 3.5 關鍵字提取擴展測試 (16個單元測試) - test_keyword_extraction_extended.py

#### API-KW-401-UT: 英文檢測選擇英文 prompt
- **名稱**: 驗證英文檢測後選擇正確的英文 prompt
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 確保英文 JD 使用英文 prompt
- **測試文件**: test_keyword_extraction_extended.py::test_english_detection_selects_english_prompt

#### API-KW-402-UT: 中文檢測選擇中文 prompt
- **名稱**: 驗證中文檢測後選擇正確的中文 prompt
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 確保中文 JD 使用中文 prompt
- **測試文件**: test_keyword_extraction_extended.py::test_chinese_detection_selects_chinese_prompt

#### API-KW-403-UT: 混合語言 prompt 選擇
- **名稱**: 混合語言的 prompt 選擇邏輯
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證混合語言時的 prompt 選擇
- **測試文件**: test_keyword_extraction_extended.py::test_mixed_language_prompt_selection

#### API-KW-404-UT: 不支援語言錯誤
- **名稱**: 不支援語言引發錯誤
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證不支援語言正確拋出錯誤
- **測試文件**: test_keyword_extraction_extended.py::test_unsupported_language_raises_error

#### API-KW-405-UT: 明確語言參數跳過檢測
- **名稱**: 明確指定語言參數時跳過自動檢測
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 language 參數覆蓋自動檢測
- **測試文件**: test_keyword_extraction_extended.py::test_explicit_language_bypasses_detection

#### API-KW-406-UT: 無效明確語言錯誤
- **名稱**: 無效的明確語言參數引發錯誤
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證無效語言參數的錯誤處理
- **測試文件**: test_keyword_extraction_extended.py::test_invalid_explicit_language_raises_error

#### API-KW-407-UT: Prompt 管理器初始化
- **名稱**: 測試 prompt 管理器初始化
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 prompt 管理器正確初始化
- **測試文件**: test_keyword_extraction_extended.py::test_prompt_manager_initialization

#### API-KW-408-UT: 獲取英文 prompt
- **名稱**: 測試獲取英文 prompt
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證能正確獲取英文 prompt
- **測試文件**: test_keyword_extraction_extended.py::test_get_english_prompt

#### API-KW-409-UT: 獲取中文 prompt
- **名稱**: 測試獲取中文 prompt
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證能正確獲取中文 prompt
- **測試文件**: test_keyword_extraction_extended.py::test_get_chinese_prompt

#### API-KW-410-UT: 格式化 prompt
- **名稱**: 測試 prompt 格式化功能
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 JD 正確插入 prompt 模板
- **測試文件**: test_keyword_extraction_extended.py::test_format_prompt_with_job_description

#### API-KW-411-UT: 不支援語言 prompt 錯誤
- **名稱**: 獲取不支援語言的 prompt 引發錯誤
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證不支援語言的錯誤處理
- **測試文件**: test_keyword_extraction_extended.py::test_get_unsupported_language_raises_error

#### API-KW-412-UT: 空 JD 處理
- **名稱**: 空職缺描述處理
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證空 JD 的錯誤處理
- **測試文件**: test_keyword_extraction_extended.py::test_empty_job_description_handling

#### API-KW-413-UT: 極短 JD 處理
- **名稱**: 極短職缺描述處理
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證極短 JD 的處理
- **測試文件**: test_keyword_extraction_extended.py::test_very_short_job_description

#### API-KW-414-UT: 純數字符號處理
- **名稱**: 純數字和符號的處理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證純數字符號內容的處理
- **測試文件**: test_keyword_extraction_extended.py::test_numbers_and_symbols_only

#### API-KW-415-UT: 成功時服務清理
- **名稱**: 成功執行後的服務清理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證成功後正確清理服務資源
- **測試文件**: test_keyword_extraction_extended.py::test_service_cleanup_on_success

#### API-KW-416-UT: 錯誤時服務清理
- **名稱**: 錯誤發生時的服務清理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證錯誤時正確清理服務資源
- **測試文件**: test_keyword_extraction_extended.py::test_service_cleanup_on_error

### 3.6 語言檢測整合測試 (15個)

#### API-KW-301-IT: 英文 JD 使用英文 prompt
- **名稱**: 端到端驗證英文職缺使用英文 prompt
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: detected_language="en", prompt_version 包含 "en"

#### API-KW-302-IT: 繁中 JD 使用繁中 prompt
- **名稱**: 端到端驗證繁中職缺使用繁中 prompt
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: detected_language="zh-TW", prompt_version 包含 "zh-TW"

#### API-KW-303-IT: 混合語言（>20%繁中）
- **名稱**: 混合語言正確選擇 prompt
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: detected_language="zh-TW", 使用繁中 prompt

#### API-KW-304-IT: 混合語言（<20%繁中）
- **名稱**: 混合語言低於閾值時使用英文 prompt
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: detected_language="en", prompt_version 包含 "en"

#### API-KW-305-IT: 拒絕簡體中文
- **名稱**: API 正確回傳 400 錯誤（簡中）
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: HTTP 400, error.code="UNSUPPORTED_LANGUAGE"

#### API-KW-306-IT: 拒絕日文
- **名稱**: API 正確拒絕日文 JD
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: HTTP 400, error.code="UNSUPPORTED_LANGUAGE"

#### API-KW-307-IT: 拒絕韓文
- **名稱**: API 正確拒絕韓文 JD
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: HTTP 400, error.code="UNSUPPORTED_LANGUAGE"

#### API-KW-308-IT: 拒絕混合不支援語言
- **名稱**: API 正確拒絕混合不支援語言
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: HTTP 400 + UNSUPPORTED_LANGUAGE

#### API-KW-309-IT: 語言參數覆蓋測試
- **名稱**: 明確指定 language 參數時的 API 行為
- **優先級**: P1
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: 使用指定的語言 prompt，不進行自動檢測

#### API-KW-310-IT: 錯誤回應格式驗證
- **名稱**: 不支援語言時的錯誤回應結構
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: 驗證錯誤回應包含完整結構

#### API-KW-311-IT: 20%閾值整合測試
- **名稱**: 正好 20% 繁中的整合測試
- **優先級**: P1
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: 邊界條件的端到端驗證

#### API-KW-312-IT: 最小長度驗證整合
- **名稱**: JD 最小長度要求的整合測試
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: < 200 字元返回驗證錯誤

#### API-KW-313-IT: 語言檢測元資料回應
- **名稱**: API 回應包含語言檢測元資料
- **優先級**: P1
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: 回應包含 detected_language 等元資料

#### API-KW-314-IT: 不支援語言詳細錯誤
- **名稱**: 不支援語言的完整錯誤詳情
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-002
- **測試目標**: 錯誤包含語言組成分析詳情

#### API-KW-315-PT: 關鍵字提取效能
- **名稱**: 關鍵字提取回應時間測試
- **優先級**: P1
- **類型**: 效能測試
- **需求編號**: REQ-002
- **測試目標**: 驗證回應時間 < 3秒

### 3.7 LLM Factory 部署映射測試 (8個)

#### SVC-LLM-501-UT: 部署映射常數存在驗證
- **名稱**: 驗證 DEPLOYMENT_MAP 常數存在且配置正確
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 DEPLOYMENT_MAP 包含 gpt4o-2 和 gpt41-mini 的映射
- **測試文件**: test_llm_factory_deployment_mapping.py::test_deployment_map_constants

#### SVC-LLM-502-UT: GPT-4o-2 部署映射
- **名稱**: 驗證 gpt4o-2 正確映射到 gpt-4.1-japan 部署
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 確保 gpt4o-2 模型使用正確的 Azure 部署名稱
- **測試文件**: test_llm_factory_deployment_mapping.py::test_gpt4o2_deployment_mapping

#### SVC-LLM-503-UT: GPT-4.1 Mini 部署映射
- **名稱**: 驗證 gpt41-mini 正確映射到專用客戶端
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 確保 gpt41-mini 模型使用 GPT-4.1 Mini 專用客戶端
- **測試文件**: test_llm_factory_deployment_mapping.py::test_gpt41_mini_deployment_mapping

#### SVC-LLM-504-UT: GPT-4.1 Mini 容錯回退
- **名稱**: 測試 GPT-4.1 Mini 失敗時回退到 GPT-4o-2
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 GPT-4.1 Mini 不可用時自動回退機制
- **測試文件**: test_llm_factory_deployment_mapping.py::test_gpt41_mini_fallback_to_gpt4o2

#### SVC-LLM-505-UT: 未知模型預設映射
- **名稱**: 測試未知模型使用預設部署
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 確保未知模型回退到預設的 gpt-4.1-japan 部署
- **測試文件**: test_llm_factory_deployment_mapping.py::test_unknown_model_uses_default_mapping

#### SVC-LLM-506-UT: 直接模型規格
- **名稱**: 測試 get_llm_client 直接指定模型參數
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 model 參數正確傳遞到 _create_client
- **測試文件**: test_llm_factory_deployment_mapping.py::test_get_llm_client_with_model_parameter

#### SVC-LLM-507-UT: Smart Client 請求參數
- **名稱**: 測試 get_llm_client_smart 的 request_model 參數
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 request_model 參數可覆蓋預設模型選擇
- **測試文件**: test_llm_factory_deployment_mapping.py::test_get_llm_client_smart_with_request_model

#### SVC-LLM-508-UT: Smart Client Header 參數
- **名稱**: 測試 get_llm_client_smart 的 HTTP Header 模型參數
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-002
- **測試目標**: 驗證 X-LLM-Model Header 可指定使用的模型
- **測試文件**: test_llm_factory_deployment_mapping.py::test_get_llm_client_smart_with_header_model

## 3.8 Index Calculation V2 模組 (IC) - 27個測試案例

### 單元測試 (10個)

#### API-IC-001-UT: 服務初始化測試
- **名稱**: IndexCalculationServiceV2 服務初始化
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-003
- **測試目標**: 驗證服務正確初始化，所有依賴正確注入

#### API-IC-002-UT: 快取鍵生成測試
- **名稱**: 快取鍵生成的一致性和唯一性
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-003
- **測試目標**: 驗證相同文本產生相同鍵，不同文本產生不同鍵

#### API-IC-003-UT: 快取TTL過期測試
- **名稱**: 快取項目的 TTL 過期機制
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-003
- **測試目標**: 驗證快取項目過期後被正確清理

#### API-IC-004-UT: 快取LRU淘汰測試
- **名稱**: LRU 淘汰策略在快取滿時正確運作
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-003
- **測試目標**: 驗證最少使用的項目被優先淘汰

#### API-IC-005-UT: 相似度計算整合測試
- **名稱**: 整個相似度計算流程的正確性
- **優先級**: P2
- **類型**: 單元測試
- **需求編號**: REQ-003
- **測試目標**: 驗證 embedding 和 sigmoid 轉換的整合

#### API-IC-006-UT: Sigmoid轉換參數一致性測試
- **名稱**: 確保 sigmoid 轉換參數與 V1 保持一致
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-003
- **測試目標**: 驗證 k=15.0, x0=0.373 參數正確

#### API-IC-007-UT: 關鍵字覆蓋分析測試
- **名稱**: 關鍵字匹配邏輯的正確性
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-003
- **測試目標**: 驗證大小寫不敏感、複數形式匹配、字詞邊界匹配

#### API-IC-008-UT: TinyMCE HTML清理測試
- **名稱**: TinyMCE 生成的 HTML 能正確清理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-003
- **測試目標**: 驗證 HTML 標籤移除、實體解碼、結構保留

#### API-IC-009-UT: TaskGroup並行執行測試
- **名稱**: Python 3.11 TaskGroup 的並行執行正確性
- **優先級**: P0
- **類型**: 單元測試
- **需求編號**: REQ-003
- **測試目標**: 驗證多任務並行執行，無競爭條件

#### API-IC-010-UT: TaskGroup錯誤處理測試
- **名稱**: TaskGroup 的 ExceptionGroup 錯誤處理
- **優先級**: P1
- **類型**: 單元測試
- **需求編號**: REQ-003
- **測試目標**: 驗證單一或多任務失敗時的錯誤處理

### 整合測試 (12個)

#### API-IC-101-IT: API端點基本功能測試
- **名稱**: POST /api/v1/index-calculation 端點正常運作
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證端點回應、格式、Bubble.io 固定 schema

#### API-IC-102-IT: 快取行為整合測試
- **名稱**: 快取在 API 層級的正確行為
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證 cache_hit 欄位正確，Cache hit 時間 < 50ms

#### API-IC-103-IT: 輸入驗證測試
- **名稱**: 各種無效輸入的錯誤處理
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證空履歷、過短/過長文本的錯誤處理

#### API-IC-104-IT: Azure OpenAI 速率限制錯誤測試
- **名稱**: Azure OpenAI 速率限制錯誤處理
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證 AzureOpenAIRateLimitError 返回 429 狀態碼，錯誤訊息格式正確

#### API-IC-105-IT: Azure OpenAI 認證錯誤測試
- **名稱**: Azure OpenAI 認證錯誤處理
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證 AzureOpenAIAuthError 返回 401 狀態碼，UnifiedResponse 格式正確

#### API-IC-106-IT: Azure OpenAI 伺服器錯誤測試
- **名稱**: Azure OpenAI 伺服器錯誤處理
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證 AzureOpenAIServerError 返回 503 狀態碼，錯誤處理流程正確

#### API-IC-107-IT: 並發請求處理測試
- **名稱**: 高並發請求下的系統穩定性
- **優先級**: P1
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證 10 個並發請求全部成功，無競爭條件

#### API-IC-108-IT: 大文檔處理測試
- **名稱**: 大文檔的處理能力和效能
- **優先級**: P1
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證 10KB、20KB、30KB 文檔處理，P95 < 2秒

#### API-IC-109-IT: 服務統計端點測試
- **名稱**: GET /api/v1/index-calculation/stats 端點
- **優先級**: P2
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證統計資料正確性、cache_hit_rate 計算

#### API-IC-110-IT: 跨語言內容測試
- **名稱**: 中英文混合內容的處理
- **優先級**: P1
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證中英混合內容無編碼錯誤，相似度計算正確

#### API-IC-111-IT: 高並發功能測試
- **名稱**: 應用層高並發處理能力（使用 mock）
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證應用層能正確處理高並發請求，無競爭條件

#### API-IC-112-IT: 記憶體管理測試
- **名稱**: 記憶體使用效率和無洩漏測試（使用 mock）
- **優先級**: P1
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證應用層無記憶體洩漏，GC 後正確回收

#### API-IC-113-IT: 快取LRU功能測試
- **名稱**: 快取 LRU 淘汰邏輯正確性（使用 mock）
- **優先級**: P1
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證快取大小限制執行，LRU 淘汰邏輯正確

#### API-IC-114-IT: 錯誤恢復機制測試
- **名稱**: 系統錯誤恢復能力測試（使用 mock）
- **優先級**: P0
- **類型**: 整合測試
- **需求編號**: REQ-003
- **測試目標**: 驗證重試邏輯、fallback 機制、錯誤處理流程

### 效能測試 (2個)

#### API-IC-201-PT: 響應時間基準測試
- **名稱**: 建立效能基準並驗證是否達到目標
- **優先級**: P0
- **類型**: 效能測試
- **測試目標**: 建立 Index Calculation API 的響應時間基準（P50、P95）
- **測試內容**: 使用中型JD（約500字）執行30次請求，計算響應時間分佈
- **判斷標準**: 
  - P50 < 1秒
  - P95 < 2秒


#### API-IC-203-PT: 高並發負載測試
- **名稱**: 模擬負載測試（TestClient 限制）
- **優先級**: P1
- **類型**: 效能測試
- **測試目標**: 驗證系統在持續負載下的穩定性和效能表現
- **測試內容**: 模擬 5 QPS 持續 5 秒（總計 25 個請求），序列執行以避免 TestClient 事件循環問題
- **判斷標準**:
  - 成功率 > 90%
  - P95 < 4秒
- **注意**: 由於 TestClient 限制，無法測試真正的並發，實際 QPS 約 1.7

### 端對端測試 (3個實作，1個待實作)

#### API-IC-301-E2E: 基本工作流程測試
- **名稱**: 從輸入到輸出的基本流程（真實 API）
- **優先級**: P0
- **類型**: 端對端測試
- **測試目標**: 驗證 Index Calculation API 的完整工作流程和輸出正確性
- **測試內容**: 使用中型測試資料（純文字格式）執行完整的指數計算流程
- **判斷標準**:
  - HTTP 200 響應
  - 響應結構包含所有必要欄位（raw_similarity_percentage、similarity_percentage、keyword_coverage）
  - 相似度分數在 0-100 範圍內
  - 關鍵字覆蓋率計算正確（covered + missed = total）
  - 處理時間 < 15秒
- **解決方案**: 每個測試使用新的 TestClient 實例

#### API-IC-302-E2E: HTML 格式測試
- **名稱**: HTML 格式履歷處理測試
- **優先級**: P0
- **類型**: 端對端測試
- **測試目標**: 驗證系統對不同輸入格式的相容性（HTML 格式）
- **測試內容**: 使用 HTML 格式履歷（包含標籤如 <p>、<div>、<br> 等）進行指數計算
- **判斷標準**:
  - HTTP 200 響應
  - 系統成功處理 HTML 內容（不報錯）
  - 返回有效的計算結果
- **解決方案**: 獨立測試函數，避免事件循環問題

#### API-IC-303-E2E: 字串格式關鍵字測試
- **名稱**: 字串格式關鍵字處理測試
- **優先級**: P0
- **類型**: 端對端測試
- **測試目標**: 驗證系統對關鍵字輸入格式的彈性
- **測試內容**: 使用逗號分隔的字串格式關鍵字（如 "Python, FastAPI, Docker, AWS"）而非陣列格式
- **判斷標準**:
  - HTTP 200 響應
  - 正確識別 4 個關鍵字
  - keyword_coverage.total_keywords = 4
- **解決方案**: 獨立測試函數，使用新的 TestClient

#### API-IC-304-E2E: 效能和監控整合測試（待實作）
- **名稱**: 系統穩定性和監控功能測試
- **優先級**: P2
- **類型**: 端對端測試
- **測試目標**: 驗證系統的監控和可觀測性功能
- **測試內容**: 
  - 監控事件追蹤驗證
  - 日誌格式和內容檢查
  - 錯誤處理和報告測試
  - 性能指標收集（記憶體、CPU）
  - 快取命中率監控
- **判斷標準**:
  - 每個請求都有對應的監控事件記錄
  - 日誌內容包含必要的追蹤資訊
  - 錯誤情況被正確捕獲和記錄
  - 性能指標被正確收集
- **狀態**: 待實作 - 需等待監控功能開發完成後實施
- **注意**: 目前的實作只是基本的穩定性測試，未包含真正的監控整合驗證

## 4. 測試追溯性設計

### 4.1 需求對應表
| 需求編號 | 需求描述 | 相關測試案例 | 測試數量 |
|----------|----------|-------------|----------|
| REQ-001 | 系統健康監控 | API-HLT-001~010 | 10個 |
| REQ-002 | JD 關鍵字提取與 LLM 服務 | API-KW-101~111, 211~239, 241~264, 301~315, 401~416, SVC-LLM-501~508 | 103個 |
| REQ-003 | 履歷匹配指數 (Index Calculation V2) | API-IC-001~010, 101~112, 201~203, 301~303 | 28個 |
| REQ-004 | 差距分析 | API-GAP-301~305 (預留) | 0個 |

### 4.2 覆蓋率矩陣
| 功能模組 | 單元測試 | 整合測試 | 效能測試 | 端對端測試 | 安全測試 | 總計 |
|----------|----------|----------|----------|------------|----------|------|
| 健康檢查 | ✅ 9個 | ✅ 1個 | - | - | - | 10個 |
| 關鍵字提取 | ✅ 79個 | ✅ 15個 | ✅ 1個 | - | ⏳ | 95個 |
| LLM Factory | ✅ 8個 | - | - | - | - | 8個 |
| 匹配指數 V2 | ✅ 10個 | ✅ 12個 | ✅ 3個 | ✅ 2個 | ⏳ | 27個 |
| 差距分析 | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ | 0個 |
| **總計** | **106個** | **28個** | **4個** | **2個** | **0個** | **140個** |

**圖例**: ✅ 已完成 | ⏳ 計劃中 | - 不適用

## 5. 測試資料規範

### 5.1 資料分類

測試資料目錄結構：

```
fixtures/
├── jd/                 # 職缺描述範例
│   ├── valid/         # 有效輸入
│   ├── invalid/       # 無效輸入
│   └── edge_cases/    # 邊界案例
├── resumes/           # 履歷範例
├── responses/         # API 回應範例
└── configs/           # 測試配置
```

### 5.2 命名規範
- 有效資料: `valid_[描述]_[序號].json`
- 無效資料: `invalid_[錯誤類型]_[序號].json`
- 邊界案例: `edge_[案例類型]_[序號].json`

## 6. 測試執行規範

### 6.1 完整測試套件 - run_complete_test_suite.sh

#### 6.1.1 基本用法

```bash
# 執行核心測試（單元 + 整合）- 預設行為
./test/scripts/run_complete_test_suite.sh

# 顯示說明文件
./test/scripts/run_complete_test_suite.sh --help
```

#### 6.1.2 進階選項

| 選項 | 簡寫 | 說明 | 使用時機 |
|------|------|------|----------|
| `--include-performance` | - | 包含所有效能測試（6個） | 需要驗證效能表現 |
| `--include-e2e` | - | 包含 E2E 測試（3個） | 完整功能驗證 |
| `--index-calc-only` | - | 僅執行 Index Calculation V2 測試 | 開發或除錯特定模組 |
| `--background` | `-b` | 在背景執行 | 長時間測試或 CI/CD |
| `--stage <stage>` | - | 執行特定階段 | 快速測試特定類型 |
| `--performance` | `-p` | 僅執行效能測試 | 效能專注測試 |

#### 6.1.3 Stage 選項值

- `unit` - 僅執行單元測試（106個）
- `integration` - 僅執行整合測試（24個）
- `performance` - 僅執行效能測試（6個）
- `e2e` - 僅執行 E2E 測試（3個）

#### 6.1.4 使用範例

```bash
# 執行所有測試（包含效能和 E2E）
./test/scripts/run_complete_test_suite.sh --include-performance --include-e2e

# 僅執行單元測試
./test/scripts/run_complete_test_suite.sh --stage unit

# 僅執行效能測試
./test/scripts/run_complete_test_suite.sh --performance
# 或
./test/scripts/run_complete_test_suite.sh --stage performance

# 僅測試 Index Calculation V2 模組
./test/scripts/run_complete_test_suite.sh --index-calc-only

# 在背景執行完整測試
./test/scripts/run_complete_test_suite.sh --include-performance --include-e2e --background

# 執行 Index Calculation V2 的效能測試
./test/scripts/run_complete_test_suite.sh --index-calc-only --stage performance
```

#### 6.1.5 預估執行時間

| 測試類型 | 測試數量 | 預估時間 |
|----------|----------|----------|
| 單元測試 | 106 | ~40 秒 |
| 整合測試 | 24 | ~30 秒 |
| 效能測試 | 6 | ~90 秒 |
| E2E 測試 | 3 | ~30 秒 |
| **全部** | **139** | **~190 秒** |

#### 6.1.6 測試報告輸出

測試報告儲存在 `/test/logs/` 目錄：

| 檔案類型 | 檔名格式 | 說明 |
|----------|----------|------|
| 完整日誌 | `complete_test_YYYYMMDD_HHMMSS.log` | 完整測試執行日誌 |
| 錯誤日誌 | `error_YYYYMMDD_HHMMSS.log` | 失敗測試的詳細錯誤資訊 |
| 摘要 JSON | `summary_YYYYMMDD_HHMMSS.json` | 測試結果摘要（JSON 格式） |
| 進度檔案 | `.test_progress` | 目前測試進度（背景執行時） |

#### 6.1.7 測試結果統計表

執行完成後會顯示詳細的測試統計表：

| 模組                | 單元測試 | 整合測試 | 效能測試 | E2E測試 | 總計 |
|-------------------|----------|----------|----------|---------|------|
| 健康檢查          | 9/0      | 1/0      | 0/0      | 0/0     | 10/0 |
| 關鍵字提取        | 27/0     | 1/0      | 1/0*     | 0/0     | 29/0 |
| 語言檢測          | 29/0     | 14/0     | 0/0      | 0/0     | 43/0 |
| Prompt管理        | 24/0     | 0/0      | 0/0      | 0/0     | 24/0 |
| LLM Factory       | 8/0      | 0/0      | 0/0      | 0/0     | 8/0  |
| Index Calculation V2 | 10/0  | 12/0     | 3/0*     | 2/0*    | 27/0 |
|-------------------|----------|----------|----------|---------|------|
| **總計**          | **107/0**| **28/0** | **4/0**  | **2/0** | **140/0** |

\* 表示視選項執行

#### 6.1.8 清理機制

- 自動保留最新 6 份日誌檔案
- 刪除超過 1 天的進度檔案
- 成功執行後清理所有臨時檔案

#### 6.1.9 環境要求

- Python 3.11.8 (pyenv 管理)
- 必須存在 `.env` 檔案
- 自動啟動 API 伺服器（port 8000）
- 自動安裝缺少的依賴

### 6.2 其他測試指令

```bash
# Level 0: Prompt 驗證
./scripts/run_level0_tests.sh

# Level 1: 程式碼品質
./run_level1_tests.sh

# Level 2: 單元測試
python run_level2_tests.py

# Index Calculation V2 專用測試
./test/scripts/run_index_calculation_v2_tests.sh        # 完整測試
./test/scripts/run_index_calculation_v2_performance.sh  # 2分鐘效能測試

# 特定模組測試
pytest tests/unit/test_keyword_extraction.py -v

# 指定測試案例
pytest tests/unit/test_keyword_extraction.py::test_API_KW_101_UT -v

# 查看測試結果
./test/scripts/view_test_results.sh
```

### 6.3 測試標記 (Markers)

```python
@pytest.mark.unit          # 單元測試
@pytest.mark.integration   # 整合測試
@pytest.mark.performance   # 效能測試
@pytest.mark.security      # 安全測試
@pytest.mark.p0           # P0 優先級
@pytest.mark.p1           # P1 優先級
@pytest.mark.p2           # P2 優先級
```

## 7. 擴充指南

### 7.1 新增測試案例
1. 選擇適當的模組代碼
2. 使用下一個可用序號
3. 遵循命名規範
4. 更新追溯矩陣
5. 實作測試程式碼

### 7.2 新增功能模組
1. 在編號系統中定義新模組代碼
2. 分配序號範圍 (預留充足空間)
3. 建立對應的測試檔案
4. 更新測試矩陣

## 8. 最佳實踐

### 8.1 測試設計原則
- **獨立性**: 每個測試可獨立執行
- **重複性**: 多次執行結果一致
- **快速性**: 單元測試 < 100ms
- **清晰性**: 測試名稱即文檔

### 8.2 程式碼規範

```python
# 測試函數命名
def test_[測試編號]_[簡短描述]():
    """測試案例: [編號] - [完整描述]"""
    # Arrange
    # Act  
    # Assert

# 測試類別組織
class Test[模組名稱]:
    """[模組]相關測試"""
    
    @pytest.fixture
    def setup_data(self):
        """測試資料準備"""
        pass
```

---

**注意事項**:
- 測試編號一旦分配不可更改
- 刪除的測試案例編號不可重用
- 定期審查並更新測試規格

## 9. 測試案例統計摘要

### 9.1 總體統計
- **總測試案例數**: 139個
- **已實作模組**: 4個（健康檢查、關鍵字提取、LLM Factory、Index Calculation V2）
- **待開發模組**: 4個以上

### 9.2 詳細分布

| 模組                               | 單元測試 | 整合測試 | 效能測試 | E2E測試 | 總計    |
| ---------------------------------- | -------- | -------- | -------- | ------- | ------- |
| 健康檢查 (HLT)                     | 9        | 1        | 0        | 0       | 10      |
| 關鍵字提取 (KW 101-111, 401-416, 315) | 26       | 1        | 1        | 0       | 28      |
| 語言檢測 (KW 211-239, 301-314)     | 29       | 14       | 0        | 0       | 43      |
| Prompt管理 (KW 241-264)            | 24       | 0        | 0        | 0       | 24      |
| LLM Factory 部署映射 (LLM 501-508) | 8        | 0        | 0        | 0       | 8       |
| Index Calculation V2 (IC 001-303)   | 10       | 8        | 5        | 3       | 26      |
| **總計**                           | **106**  | **24**   | **6**    | **3**   | **139** |

### 9.3 編號系統說明
**重要提醒**: 
- TEST_MATRIX.md 使用編號格式：`TEST-HC-XXX`, `TEST-KW-XXX`
- TEST_SPEC.md 使用編號格式：`API-HLT-XXX`, `API-KW-XXX`, `SVC-LLM-XXX`
- 兩份文件的編號系統需要統一，建議採用 TEST_SPEC.md 的格式作為標準
- 新增服務層測試使用 `SVC-` 前綴，如 LLM Factory 使用 `SVC-LLM-XXX`

### 9.4 與專案整體測試統計

本文檔記錄：
- 健康檢查：10個（9個單元測試 + 1個整合測試）
- 關鍵字提取：95個（79個單元測試 + 15個整合測試 + 1個效能測試）
- LLM Factory：8個（8個單元測試）
- Index Calculation V2：26個（10個單元測試 + 8個整合測試 + 5個效能測試 + 3個E2E測試）
- **TEST_SPEC.md 總計：139個測試案例**

測試分布特色：
1. Index Calculation V2 擁有最完整的測試覆蓋，包含所有測試類型
2. 效能測試集中在關鍵字提取和 Index Calculation V2 兩個核心功能
3. E2E 測試目前只有 Index Calculation V2 實作，其他模組待開發
4. 所有新增測試都遵循統一的編號規範（API-XXX-XXX-YY）

### 9.5 效能測試文件名稱說明

**效能測試實作說明**：

| 文件名稱 | 位置 | 狀態 | 說明 |
|----------|------|------|------|
| test_keyword_extraction_performance_simple.py | test/performance/ | ✅ 正式使用 | 實際執行的效能測試，對應 API-KW-315-PT |
| test_keyword_extraction_performance.py | test/performance/ | ⚠️ 已棄用 | 舊版效能測試，不再使用 |

**確認事項**：
- `test_keyword_extraction_performance_simple.py` 是正確且唯一的關鍵字提取效能測試實作
- 該文件被 `run_complete_test_suite.sh` 正確引用並執行
- 測試編號 API-KW-315-PT 對應到此文件