# Index Calculation V2 測試規格

## 概述

本文件定義了 Index Calculation V2 功能的完整測試規格，包含單元測試、整合測試、效能測試和端到端測試。

### 測試範圍
- **API端點**: `/api/v1/index-calculation`
- **核心功能**: 計算履歷與職缺描述的匹配指數
- **測試腳本**: 
  - `run_index_calculation_unit_integration.sh` - 單元和整合測試
  - `run_index_calculation_real_api_perf_e2e.sh` - 效能和E2E測試

### 測試統計
- **總測試數**: 26個（原30個，移除4個重複錯誤處理測試）
- **Mock測試**: 20個（10 UT + 10 IT，移除4個IT）
- **Real API測試**: 6個（2 PT + 4 E2E，保持不變）
- **移除測試**: API-IC-103/104/105/106-IT（合併至ERROR_HANDLER）

---

## 單元測試 (Unit Tests)

### API-IC-001-UT: 服務初始化測試
- **名稱**: 測試 Index Calculation 服務的初始化
- **優先級**: P0
- **類型**: 單元測試
- **測試目標**: 驗證服務初始化和配置載入
- **測試內容**: 測試服務實例創建、配置參數載入、依賴注入
- **判斷標準**: 
  - 服務成功初始化
  - 配置正確載入
  - 依賴服務可用

### API-IC-002-UT: 快取鍵生成測試
- **名稱**: 測試快取鍵的生成邏輯
- **優先級**: P0
- **類型**: 單元測試
- **測試目標**: 驗證快取鍵生成的一致性和唯一性
- **測試內容**: 測試相同輸入產生相同鍵、不同輸入產生不同鍵
- **判斷標準**: 
  - 快取鍵格式正確
  - 雜湊值穩定一致

### API-IC-003-UT: 快取TTL過期測試
- **名稱**: 測試快取過期時間機制
- **優先級**: P1
- **類型**: 單元測試
- **測試目標**: 驗證快取TTL（Time To Live）功能
- **測試內容**: 測試快取項目在TTL後過期、過期項目被清除
- **判斷標準**: 
  - TTL時間正確設置
  - 過期項目無法取得

### API-IC-004-UT: 快取LRU淘汰測試
- **名稱**: 測試快取LRU淘汰機制
- **優先級**: P1
- **類型**: 單元測試
- **測試目標**: 驗證LRU（Least Recently Used）淘汰策略
- **測試內容**: 測試快取滿時最少使用項目被淘汰
- **判斷標準**: 
  - 最久未使用項目被移除
  - 新項目成功加入

### API-IC-005-UT: 相似度計算整合測試
- **名稱**: 測試相似度計算的完整流程
- **優先級**: P0
- **類型**: 單元測試
- **測試目標**: 驗證相似度計算服務的整合
- **測試內容**: 測試向量生成到相似度計算的完整流程
- **判斷標準**: 
  - 相似度在0-1之間
  - 計算結果合理

### API-IC-006-UT: Sigmoid轉換參數測試
- **名稱**: 測試Sigmoid函數轉換參數
- **優先級**: P0
- **類型**: 單元測試
- **測試目標**: 驗證分數轉換的Sigmoid函數參數
- **測試內容**: 測試不同參數下的轉換曲線
- **判斷標準**: 
  - 轉換後分數在0-100之間
  - 曲線形狀符合預期

### API-IC-007-UT: 關鍵字覆蓋分析測試
- **名稱**: 測試關鍵字覆蓋率分析邏輯
- **優先級**: P0
- **類型**: 單元測試
- **測試目標**: 驗證關鍵字匹配和覆蓋率計算
- **測試內容**: 測試各種匹配場景（完全、部分、無匹配）
- **判斷標準**: 
  - 覆蓋率計算準確
  - 大小寫不敏感

### API-IC-008-UT: TinyMCE HTML清理測試
- **名稱**: 測試HTML內容清理功能
- **優先級**: P1
- **類型**: 單元測試
- **測試目標**: 驗證TinyMCE HTML標籤的清理
- **測試內容**: 測試HTML標籤移除、純文字提取
- **判斷標準**: 
  - HTML標籤完全移除
  - 文字內容保留完整

### API-IC-009-UT: TaskGroup並行執行測試
- **名稱**: 測試TaskGroup並行任務執行
- **優先級**: P0
- **類型**: 單元測試
- **測試目標**: 驗證並行任務執行機制
- **測試內容**: 測試多任務並行執行、結果收集
- **判斷標準**: 
  - 任務並行執行
  - 結果正確收集

### API-IC-010-UT: TaskGroup錯誤處理測試
- **名稱**: 測試TaskGroup錯誤處理機制
- **優先級**: P0
- **類型**: 單元測試
- **測試目標**: 驗證並行任務的錯誤處理
- **測試內容**: 測試單一任務失敗、多任務失敗場景
- **判斷標準**: 
  - 錯誤被正確捕獲
  - 其他任務不受影響

---

## 整合測試 (Integration Tests)

### API-IC-101-IT: API端點基本功能測試
- **名稱**: 測試API端點的基本功能
- **優先級**: P0
- **類型**: 整合測試
- **測試目標**: 驗證API端點的基本可用性
- **測試內容**: 使用有效輸入測試完整的API流程
- **判斷標準**: 
  - 返回200狀態碼
  - 包含所有必要欄位
  - 計算結果合理

### API-IC-102-IT: 快取行為整合測試
- **名稱**: 測試快取的整合行為
- **優先級**: P0
- **類型**: 整合測試
- **測試目標**: 驗證快取在API層級的行為
- **測試內容**: 重複請求測試快取命中、不同請求測試快取未命中
- **判斷標準**: 
  - 相同請求返回快取結果
  - 快取命中時響應更快

### API-IC-103-IT: 輸入驗證測試 [已合併至ERROR_HANDLER]
- **狀態**: ⚠️ **已移除** - 合併至 ERR-016-UT (通用驗證錯誤處理)
- **名稱**: 測試API輸入驗證
- **優先級**: P0
- **類型**: 整合測試
- **測試目標**: 驗證輸入參數的完整性檢查
- **測試內容**: 測試缺少參數、無效參數、超長輸入
- **判斷標準**: 
  - 返回400錯誤碼
  - 錯誤訊息明確

### API-IC-104-IT: Azure OpenAI速率限制錯誤測試 [已合併至ERROR_HANDLER]
- **狀態**: ⚠️ **已移除** - 合併至 ERR-017-UT (通用外部服務錯誤分類)
- **名稱**: 測試Azure OpenAI速率限制錯誤處理
- **優先級**: P0
- **類型**: 整合測試
- **測試目標**: 驗證速率限制錯誤的處理
- **測試內容**: 模擬 AzureOpenAIRateLimitError
- **判斷標準**: 
  - 返回429錯誤碼
  - 包含 "rate limit" 錯誤訊息

### API-IC-105-IT: Azure OpenAI認證錯誤測試 [已合併至ERROR_HANDLER]
- **狀態**: ⚠️ **已移除** - 合併至 ERR-017-UT (通用外部服務錯誤分類)
- **名稱**: 測試Azure OpenAI認證錯誤處理
- **優先級**: P0
- **類型**: 整合測試
- **測試目標**: 驗證認證錯誤的處理
- **測試內容**: 模擬 AuthenticationError（401/403錯誤）
- **判斷標準**: 
  - 返回401錯誤碼（Unauthorized）或403（Forbidden）
  - 錯誤訊息包含 "authentication"
  - 不洩露敏感的認證資訊

### API-IC-106-IT: Azure OpenAI伺服器錯誤測試 [已合併至ERROR_HANDLER]
- **狀態**: ⚠️ **已移除** - 合併至 ERR-017-UT (通用外部服務錯誤分類)
- **名稱**: 測試Azure OpenAI伺服器錯誤處理
- **優先級**: P1
- **類型**: 整合測試
- **測試目標**: 驗證伺服器錯誤的處理
- **測試內容**: 模擬 ExternalServiceError（500+錯誤）
- **判斷標準**: 
  - 返回502錯誤碼（Bad Gateway）
  - 錯誤訊息包含 "external service error"
  - 包含友善錯誤訊息，不暴露內部細節

### API-IC-107-IT: 並發請求處理測試
- **名稱**: 測試並發請求的處理能力
- **優先級**: P2
- **類型**: 整合測試
- **測試目標**: 驗證系統的並發處理能力
- **測試內容**: 同時發送10個不同的請求
- **判斷標準**: 
  - 所有請求成功完成
  - 無資源競爭問題

### API-IC-108-IT: 大文檔處理測試
- **名稱**: 測試大型文檔的處理
- **優先級**: P1
- **類型**: 整合測試
- **測試目標**: 驗證系統處理大型文檔的能力
- **測試內容**: 使用2000+字的履歷和職缺描述
- **判斷標準**: 
  - 成功處理不超時
  - 記憶體使用合理

### API-IC-109-IT: 服務統計端點測試
- **名稱**: 測試服務統計資訊端點
- **優先級**: P0
- **類型**: 整合測試
- **測試目標**: 驗證統計資訊的收集和展示
- **測試內容**: 訪問 `/api/v1/index-calculation/stats` 端點
- **判斷標準**: 
  - 返回正確的統計數據
  - 包含請求計數、快取統計等

### API-IC-110-IT: 跨語言內容測試
- **名稱**: 測試多語言內容支援
- **優先級**: P1
- **類型**: 整合測試
- **測試目標**: 驗證國際化支援
- **測試內容**: 使用中文、日文、英文混合內容
- **判斷標準**: 
  - 正確處理UTF-8編碼
  - 計算結果合理

### API-IC-111-IT: 高並發功能測試
- **名稱**: 測試高並發下的功能正確性
- **優先級**: P1
- **類型**: 整合測試
- **測試目標**: 驗證高負載下功能的正確性
- **測試內容**: 50個並發請求
- **判斷標準**: 
  - 所有請求返回正確結果
  - 無錯誤發生

### API-IC-112-IT: 記憶體管理測試
- **名稱**: 測試記憶體使用和回收
- **優先級**: P0
- **類型**: 整合測試
- **測試目標**: 驗證記憶體管理效率
- **測試內容**: 處理大量請求後檢查記憶體
- **判斷標準**: 
  - 無記憶體洩漏
  - GC正常運作

### API-IC-113-IT: 快取LRU功能測試
- **名稱**: 測試快取LRU淘汰功能
- **優先級**: P1
- **類型**: 整合測試
- **測試目標**: 驗證LRU淘汰在API層級的行為
- **測試內容**: 填滿快取後測試淘汰
- **判斷標準**: 
  - 最舊項目被淘汰
  - 新項目成功加入

### API-IC-114-IT: 錯誤恢復機制測試
- **名稱**: 測試錯誤後的恢復能力
- **優先級**: P0
- **類型**: 整合測試
- **測試目標**: 驗證系統從錯誤中恢復的能力
- **測試內容**: 觸發錯誤後測試後續請求
- **判斷標準**: 
  - 錯誤不影響後續請求
  - 系統狀態正常恢復

---

## 效能測試 (Performance Tests)

### API-IC-201-PT: 響應時間基準測試
- **名稱**: 建立效能基準並驗證是否達到目標
- **優先級**: P0
- **類型**: 效能測試
- **測試目標**: 建立 Index Calculation API 的響應時間基準（P50、P95）
- **測試內容**: 使用中型JD（約500字）執行30次請求，計算響應時間分佈
- **判斷標準**: 
  - P50 < 1秒
  - P95 < 2秒

### API-IC-203-PT: 高並發負載測試
- **名稱**: 測試高負載下的系統穩定性
- **優先級**: P0
- **類型**: 效能測試
- **測試目標**: 驗證系統在高負載下的穩定性和效能
- **測試內容**: 模擬10 QPS持續5秒的負載
- **判斷標準**: 
  - 成功率 > 90%
  - P95 < 4秒

---

## 端到端測試 (End-to-End Tests)

### API-IC-301-E2E: 基本工作流程測試
- **名稱**: 測試完整的API工作流程
- **優先級**: P0
- **類型**: E2E測試
- **測試目標**: 使用真實Azure API驗證完整工作流程
- **測試內容**: 使用真實測試資料執行完整的指數計算流程
- **判斷標準**: 
  - API回應成功
  - 資料結構完整
  - 處理時間 < 15秒

### API-IC-302-E2E: HTML格式測試
- **名稱**: 測試HTML格式履歷的E2E處理
- **優先級**: P1
- **類型**: E2E測試
- **測試目標**: 驗證HTML履歷在真實環境的處理
- **測試內容**: 使用包含HTML標籤的履歷進行測試
- **判斷標準**: 
  - 成功處理HTML內容
  - 返回有效的匹配結果

### API-IC-303-E2E: 字串格式關鍵字測試
- **名稱**: 測試字串格式關鍵字的E2E處理
- **優先級**: P1
- **類型**: E2E測試
- **測試目標**: 驗證字串格式關鍵字在真實環境的處理
- **測試內容**: 使用逗號分隔的關鍵字字串
- **判斷標準**: 
  - 正確解析關鍵字
  - 關鍵字覆蓋率計算正確

### API-IC-304-E2E: 監控整合測試（待實作）
- **名稱**: 測試監控和日誌整合
- **優先級**: P2
- **類型**: E2E測試
- **測試目標**: 驗證監控系統的整合
- **測試內容**: 
  - 監控事件追蹤驗證
  - 日誌格式和內容檢查
  - 錯誤處理和監控測試
  - 性能指標收集（記憶體、CPU等）
  - 快取監控驗證
- **判斷標準**: 待定義
- **狀態**: 待實作

---

## 測試執行策略

### 開發階段測試
1. **程式碼修改後**: 執行相關單元測試
2. **功能完成後**: 執行整合測試
3. **提交前**: 執行 `run_index_calculation_unit_integration.sh`

### 部署前測試
1. **效能驗證**: 執行效能測試確保達標
2. **E2E驗證**: 執行 `run_index_calculation_real_api_perf_e2e.sh`
3. **完整測試**: 兩個腳本都執行並通過

### 持續整合
- PR必須通過所有P0和P1測試
- 每日執行完整測試套件
- 效能測試結果趨勢監控

---

## 測試環境需求

### 單元和整合測試
- Python 3.8+
- pytest
- 模擬的Azure OpenAI服務

### 效能和E2E測試
- 真實的Azure OpenAI API金鑰
- 穩定的網路連線
- 足夠的API配額

---

## 錯誤處理映射說明

### 錯誤碼標準 vs 實際實作對照表 (已更新)

| 錯誤類型 | 原始錯誤 | 標準建議狀態碼 | 實作狀態碼 | 符合標準 |
|---------|----------|----------------|------------|----------|
| **速率限制** | AzureOpenAIRateLimitError (429) | 429 Too Many Requests | 429 Too Many Requests | ✅ 符合標準 |
| **認證失敗** | AzureOpenAIAuthError (401) | 401 Unauthorized | 401 Unauthorized | ✅ 符合標準 |
| **權限不足** | AzureOpenAIAuthError (403) | 403 Forbidden | 403 Forbidden | ✅ 符合標準 |
| **上游服務錯誤** | AzureOpenAIServerError (500+) | 502 Bad Gateway | 502 Bad Gateway | ✅ 符合標準 |
| **服務不可用** | ServiceError | 503 Service Unavailable | 503 Service Unavailable | ✅ 符合標準 |
| **驗證錯誤** | ValidationError | 422 Unprocessable Entity | 422 Unprocessable Entity | ✅ 符合標準 |
| **請求格式錯誤** | JSON解析錯誤 | 400 Bad Request | 400 Bad Request | ✅ 符合標準 |

### 錯誤碼標準參考（來自 FASTAPI_ERROR_CODES_STANDARD.md）

#### 4xx 客戶端錯誤
- **400 Bad Request**: 請求格式錯誤（無效JSON、參數類型錯誤）
- **401 Unauthorized**: 認證失敗（缺少token、token過期）
- **403 Forbidden**: 權限不足（角色權限不夠、資源禁止存取）
- **422 Unprocessable Entity**: 請求格式正確但語義錯誤（驗證失敗、業務規則違反）
- **429 Too Many Requests**: 請求過於頻繁（超過速率限制）

#### 5xx 伺服器錯誤
- **502 Bad Gateway**: 上游服務錯誤（外部API錯誤、資料庫連線失敗）
- **503 Service Unavailable**: 服務暫時不可用（維護中、過載、依賴服務下線）

### Index Calculation V2 錯誤碼映射流程 (2025-08-06 更新)
根據最新程式碼實現，以下是錯誤的處理流程：

1. **速率限制錯誤**
   - `AzureOpenAIRateLimitError` → `RateLimitError` → **429 Too Many Requests** ✅
   
2. **認證錯誤**
   - `AzureOpenAIAuthError` → `AuthenticationError` → **401 Unauthorized / 403 Forbidden** ✅
   - 新增了 `AuthenticationError` 類別來保留原始狀態碼
   
3. **伺服器錯誤**
   - `AzureOpenAIServerError` → `ExternalServiceError` → **502 Bad Gateway** ✅
   - 正確映射為 502 表示上游服務錯誤

4. **一般服務錯誤**
   - `ServiceError` → **503 Service Unavailable** ✅
   
5. **驗證錯誤**
   - `ValidationError` → **422 Unprocessable Entity** ✅
   
6. **JSON 解析錯誤**
   - `RequestValidationError` (type='json_invalid') → **400 Bad Request** ✅
   - 在 main.py 中特別處理 JSON 解析錯誤

### 實作細節
1. **新增異常類別**：
   - `src/services/exceptions.py`: 新增 `AuthenticationError` 類別，包含 `status_code` 屬性

2. **服務層處理**：
   - `src/services/index_calculation_v2.py`: 捕獲 `AzureOpenAIAuthError` 並轉換為 `AuthenticationError`

3. **API 層處理**：
   - `src/api/v1/index_calculation.py`: 專門處理 `AuthenticationError`，返回原始狀態碼

4. **JSON 錯誤處理**：
   - `src/main.py`: 在 `request_validation_exception_handler` 中檢查 `json_invalid` 類型

### 測試更新
- API-IC-105-IT: 現在正確期望返回 401（認證錯誤）
- API-IC-106-IT: 現在正確期望返回 502（外部服務錯誤）
- 測試使用自定義異常類別（`AuthenticationError`, `ExternalServiceError`）進行 mock

---

## 版本歷史
- v1.0.0 (2025-01-31): 初始版本，定義21個測試案例
- v1.0.1 (2025-01-31): 更新為30個測試案例，修正錯誤碼映射文檔
- v1.0.2 (2025-08-06): 更新錯誤碼實作對照表，反映認證錯誤和JSON解析錯誤的修正