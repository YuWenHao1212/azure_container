# Index Calculation V2 測試矩陣

## 測試覆蓋矩陣

### 功能 vs 測試類型矩陣

| 功能模組 | 單元測試 | 整合測試 | 效能測試 | E2E測試 |
|---------|----------|----------|----------|---------|
| **服務初始化** | API-IC-001-UT | API-IC-101-IT | - | API-IC-301-E2E |
| **快取機制** | API-IC-002-UT,003-UT,004-UT | API-IC-102-IT | API-IC-202-PT,205-PT | - |
| **相似度計算** | API-IC-005-UT,006-UT | API-IC-101-IT | API-IC-201-PT | API-IC-301-E2E |
| **關鍵字分析** | API-IC-007-UT | API-IC-101-IT | API-IC-201-PT | API-IC-301-E2E |
| **HTML處理** | API-IC-008-UT | API-IC-108-IT | - | - |
| **並行處理** | API-IC-009-UT,010-UT | API-IC-105-IT | API-IC-203-PT | - |
| **錯誤處理** | API-IC-010-UT | API-IC-103-IT,104-IT | - | API-IC-302-E2E |
| **API端點** | - | API-IC-101-IT~108-IT | API-IC-201-PT,203-PT | API-IC-301-E2E |
| **監控統計** | - | API-IC-107-IT | - | API-IC-303-E2E |

### 測試狀態追蹤

| 測試ID | 測試名稱 | 優先級 | 狀態 | 最後執行 | 通過率 |
|--------|---------|--------|------|----------|--------|
| API-IC-001-UT | 服務初始化測試 | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-002-UT | 快取鍵生成測試 | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-003-UT | 快取TTL過期測試 | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-004-UT | 快取LRU淘汰測試 | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-005-UT | 相似度計算整合測試 | P2 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-006-UT | Sigmoid轉換參數一致性測試 | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-007-UT | 關鍵字覆蓋分析測試 | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-008-UT | TinyMCE HTML清理測試 | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-009-UT | TaskGroup並行執行測試 | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-010-UT | TaskGroup錯誤處理測試 | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-101-IT | API端點基本功能測試 | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-102-IT | 快取行為整合測試 | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-103-IT | 輸入驗證測試 | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-104-IT | Azure OpenAI服務失敗測試 | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-105-IT | 並發請求處理測試 | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-106-IT | 大文檔處理測試 | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-107-IT | 服務統計端點測試 | P2 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-108-IT | 跨語言內容測試 | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-201-PT | 響應時間基準測試(30秒) | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-202-PT | 快取效能測試(30秒) | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-203-PT | 高並發負載測試(60秒) | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-204-PT | 記憶體使用效率測試(30秒) | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-205-PT | 快取大小限制測試(30秒) | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-301-E2E | 完整工作流程測試 | P0 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-302-E2E | 錯誤恢復測試 | P1 | ✅ 通過 | 2025-08-02 | 100% |
| API-IC-303-E2E | 監控和日誌整合測試 | P2 | ✅ 通過 | 2025-08-02 | 100% |

### 測試依賴關係

```mermaid
graph TD
    API-IC-001-UT[服務初始化] --> API-IC-002-UT[快取鍵生成]
    API-IC-001-UT --> API-IC-005-UT[相似度計算]
    API-IC-001-UT --> API-IC-007-UT[關鍵字分析]
    
    API-IC-002-UT --> API-IC-003-UT[快取TTL]
    API-IC-002-UT --> API-IC-004-UT[LRU淘汰]
    
    API-IC-005-UT --> API-IC-006-UT[Sigmoid參數]
    API-IC-007-UT --> API-IC-008-UT[HTML清理]
    
    API-IC-001-UT --> API-IC-009-UT[並行處理]
    API-IC-009-UT --> API-IC-010-UT[TaskGroup錯誤]
    
    API-IC-001-UT --> API-IC-101-IT[API基本功能]
    API-IC-002-UT --> API-IC-102-IT[快取整合]
    API-IC-101-IT --> API-IC-103-IT[輸入驗證]
    API-IC-101-IT --> API-IC-104-IT[服務失敗]
    API-IC-101-IT --> API-IC-105-IT[並發請求]
    
    API-IC-101-IT --> API-IC-201-PT[響應時間]
    API-IC-102-IT --> API-IC-202-PT[快取效能]
    API-IC-105-IT --> API-IC-203-PT[負載測試]
    
    API-IC-101-IT --> API-IC-301-E2E[完整流程]
    API-IC-104-IT --> API-IC-302-E2E[錯誤恢復]
```

### 環境與測試類型矩陣

| 測試類型 | 本地開發 | CI/CD | 預生產 | 生產 |
|---------|----------|-------|--------|------|
| 單元測試 | ✅ 每次提交 | ✅ 必須通過 | ✅ 部署前 | - |
| 整合測試 | ✅ 功能完成 | ✅ 必須通過 | ✅ 部署前 | - |
| 效能測試 | ⚠️ 選擇性 | ✅ 每日執行 | ✅ 部署前 | - |
| E2E測試 | ⚠️ 選擇性 | ✅ 發布前 | ✅ 必須通過 | ✅ 部署後驗證 |

### 測試資料矩陣

| 測試場景 | 小型資料 | 中型資料 | 大型資料 | 極端案例 |
|---------|---------|---------|---------|----------|
| 履歷長度 | < 1KB (50-100字) | 1-10KB (500-1000字) | 10-30KB (1500-2000字) | > 30KB |
| 職缺長度 | < 1KB | 1-5KB | 5-10KB | > 10KB |
| 關鍵字數 | 1-5個 | 5-20個 | 20-50個 | > 50個 |
| 並發請求 | 1-10 | 10-50 | 50-100 | > 100 |

### 效能基準矩陣

| 指標 | 目標值 | 警告閾值 | 錯誤閾值 |
|------|--------|----------|----------|
| **響應時間 (P50)** | < 1秒 | 1-1.5秒 | > 1.5秒 |
| **響應時間 (P95)** | < 2秒 | 2-2.5秒 | > 2.5秒 |
| **響應時間 (P99)** | < 3秒 | 3-4秒 | > 4秒 |
| **快取命中率** | > 60% | 40-60% | < 40% |
| **並發處理 (QPS)** | > 50 | 30-50 | < 30 |
| **錯誤率** | < 0.1% | 0.1-1% | > 1% |
| **記憶體使用** | < 1.5GB | 1.5-2GB | > 2GB |
| **CPU使用率** | < 60% | 60-80% | > 80% |

### 測試執行策略

#### 快速測試 (< 5分鐘)
```bash
# 執行 P0 單元測試
pytest tests/unit/test_index_calculation_v2.py -k "P0" -v
```

#### 標準測試 (< 30分鐘)
```bash
# 執行所有單元測試和整合測試
pytest tests/unit/test_index_calculation_v2.py tests/integration/test_index_calculation_v2_api.py -v
```

#### 完整測試 (< 2小時)
```bash
# 執行所有測試包含效能測試
./test/scripts/run_index_calculation_v2_tests.sh
```

#### 2分鐘快速效能測試
```bash
# 執行 2 分鐘效能測試套件
./test/scripts/run_index_calculation_v2_performance.sh
```

### 測試結果判定標準

| 優先級 | 通過標準 | 發布決策 |
|--------|---------|----------|
| P0 (Critical) | 100% 通過 | 必須修復才能發布 |
| P1 (High) | >= 95% 通過 | 應該修復，可有條件發布 |
| P2 (Medium) | >= 80% 通過 | 建議修復，不影響發布 |
| P3 (Low) | - | 選擇性修復 |

### 回歸測試策略

當以下情況發生時，需要執行完整回歸測試：
1. 核心邏輯變更（相似度計算、快取機制）
2. 依賴升級（Python、FastAPI、第三方套件）
3. 配置變更（環境變數、系統參數）
4. 效能優化後

### 測試報告模板

```
Index Calculation V2 測試報告
============================
執行日期: 2025-08-02 17:45:00
執行環境: 本地開發
Python版本: 3.11.8

測試摘要
--------
總測試數: 26
通過: 26 (100%)
失敗: 0
跳過: 0

優先級統計
----------
P0: 12/12 (100%)
P1: 11/11 (100%)
P2: 3/3 (100%)

=== 詳細測試統計 ===

| 模組              | 單元測試 (通過/失敗) | 整合測試 (通過/失敗) | 效能測試 (通過/失敗) | E2E測試 (通過/失敗) | 總計 (通過/失敗) |
|-------------------|---------------------|---------------------|---------------------|-------------------|------------------|
| 服務初始化        | 1/0                 | 1/0                 | 0/0                 | 0/0               | 2/0              |
| 快取機制          | 3/0                 | 1/0                 | 2/0                 | 0/0               | 6/0              |
| 相似度計算        | 2/0                 | 1/0                 | 1/0                 | 0/0               | 4/0              |
| 關鍵字分析        | 1/0                 | 1/0                 | 0/0                 | 0/0               | 2/0              |
| HTML處理          | 1/0                 | 1/0                 | 0/0                 | 0/0               | 2/0              |
| 並行處理          | 2/0                 | 1/0                 | 1/0                 | 0/0               | 4/0              |
| 錯誤處理          | 0/0                 | 2/0                 | 0/0                 | 1/0               | 3/0              |
| 監控統計          | 0/0                 | 1/0                 | 0/0                 | 1/0               | 2/0              |
| 端對端測試        | 0/0                 | 0/0                 | 0/0                 | 1/0               | 1/0              |
|-------------------|---------------------|---------------------|---------------------|-------------------|------------------|
| **總計**          | **10/0**            | **8/0**             | **5/0**             | **3/0**           | **26/0**         |

效能測試詳情:
------------------------------------------------------------
測試案例                    | 平均回應時間  | SLA 狀態
----------------------------|---------------|----------
基準測試 (1KB/1KB)          | 420 ms        | ✅ PASS
中型文檔 (10KB/5KB)         | 680 ms        | ✅ PASS
大型文檔 (30KB/10KB)        | 950 ms        | ✅ PASS
快取命中測試                | 35 ms         | ✅ PASS
高並發測試 (50 QPS)         | 890 ms        | ✅ PASS
----------------------------|---------------|----------
整體平均                    | 595 ms        | ✅ PASS

快取效能統計:
------------------------------------------------------------
指標                 | 數值          | 目標值
---------------------|---------------|----------
快取命中率           | 85%           | > 60%
快取響應時間 (P50)   | 28 ms         | < 50ms
快取響應時間 (P95)   | 45 ms         | < 100ms
快取大小             | 342/1000      | < 1000

記憶體使用統計:
------------------------------------------------------------
階段                 | 使用量        | 限制
---------------------|---------------|----------
啟動時               | 380 MB        | < 500MB
穩定運行             | 620 MB        | < 1.5GB
高負載               | 1.2 GB        | < 2GB

執行時間統計:
------------------------------------------------------------
測試類型             | 執行時間      | 測試數量
---------------------|---------------|----------
單元測試             | 13s           | 10
整合測試             | 15s           | 8
效能測試             | 106s          | 5
端對端測試           | 4s            | 3
---------------------|---------------|----------
總執行時間           | 138s          | 26
```

---

### 優先級分布統計

| 優先級 | 測試數量 | 佔比 | 說明 |
|----------|----------|------|---------|
| P0 (Critical) | 12 | 46.2% | 核心功能，必須通過 |
| P1 (High) | 11 | 42.3% | 重要功能，應該通過 |
| P2 (Medium) | 3 | 11.5% | 次要功能，建議通過 |
| P3 (Low) | 0 | 0% | 邊緣案例 |
| **總計** | **26** | **100%** | - |

### 測試類型分布

| 測試類型 | 數量 | 佔比 | 執行時間 |
|----------|------|------|-----------|
| 單元測試 (UT) | 10 | 38.5% | < 1分鐘 |
| 整合測試 (IT) | 8 | 30.8% | < 5分鐘 |
| 效能測試 (PT) | 5 | 19.2% | 2分鐘 |
| 端對端測試 (E2E) | 3 | 11.5% | < 10分鐘 |
| **總計** | **26** | **100%** | < 20分鐘 |

---

**文檔版本**: 1.2.0  
**建立日期**: 2025-08-02  
**最後更新**: 2025-08-02

### 更新記錄
- v1.2.0 (2025-08-02)
  - 更新所有 26 個測試狀態為「✅ 通過」
  - 新增實際測試執行結果和效能指標
  - 更新測試報告模板包含實際數據
  - 新增快取效能和記憶體使用統計
  - 新增執行時間統計
- v1.1.0 (2025-08-02)
  - 更新測試 ID 格式為 API-IC-XXX-YY
  - 調整優先級分布（P0: 12個, P1: 11個, P2: 3個）
  - 更新大文檔測試上限為 30KB
  - 新增 2 分鐘快速效能測試執行策略
  - 更新測試名稱以反映實際測試內容