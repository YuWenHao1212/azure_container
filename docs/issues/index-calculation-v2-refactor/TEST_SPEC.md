# Index Calculation V2 測試規格書

## 測試範圍與目標

### 測試目標
- 驗證所有功能符合技術規格
- 確保效能達到預定目標
- 驗證錯誤處理的完整性
- 確認與現有 API 的相容性

### 測試範圍
本測試規格涵蓋 Index Calculation V2 的所有核心功能：
1. 相似度計算
2. 關鍵字覆蓋分析
3. 快取機制
4. 並行處理
5. 錯誤處理
6. 效能指標

## 測試分類與編號系統

### 測試 ID 格式
```
IC-[類別]-[編號]
```

類別代碼：
- `UNIT` - 單元測試
- `INT` - 整合測試
- `PERF` - 效能測試
- `E2E` - 端對端測試

### 測試優先級
- P0: 關鍵功能，必須通過
- P1: 重要功能，應該通過
- P2: 次要功能，建議通過

## 詳細測試規格

### 1. 單元測試 (UNIT)

#### IC-UNIT-001: 服務初始化測試
- **優先級**: P0
- **目的**: 驗證 IndexCalculationServiceV2 正確初始化
- **輸入**: 各種配置參數組合
- **預期結果**: 服務成功初始化，所有依賴正確注入

#### IC-UNIT-002: 快取鍵生成測試
- **優先級**: P0
- **目的**: 驗證快取鍵生成的一致性和唯一性
- **輸入**: 不同的文本內容
- **預期結果**: 相同輸入產生相同鍵，不同輸入產生不同鍵

#### IC-UNIT-003: 快取 TTL 測試
- **優先級**: P1
- **目的**: 驗證快取過期機制
- **輸入**: 設定不同 TTL 的快取項目
- **預期結果**: 過期項目返回 None，未過期項目正常返回

#### IC-UNIT-004: 快取 LRU 淘汰測試
- **優先級**: P1
- **目的**: 驗證 LRU 淘汰策略
- **輸入**: 超過快取大小限制的項目
- **預期結果**: 最少使用的項目被淘汰

#### IC-UNIT-005: 相似度計算測試
- **優先級**: P0
- **目的**: 驗證相似度計算的正確性
- **輸入**: 各種履歷和職缺描述組合
- **預期結果**: 返回 0-100 的相似度分數

#### IC-UNIT-006: Sigmoid 轉換測試
- **優先級**: P0
- **目的**: 驗證 sigmoid 轉換函數
- **輸入**: 各種原始相似度值
- **預期結果**: 正確的轉換值

#### IC-UNIT-007: 關鍵字覆蓋分析測試
- **優先級**: P0
- **目的**: 驗證關鍵字匹配邏輯
- **輸入**: 履歷文本和關鍵字列表
- **預期結果**: 正確的覆蓋統計

#### IC-UNIT-008: HTML 清理測試
- **優先級**: P1
- **目的**: 驗證 HTML 標籤清理功能
- **輸入**: 包含 HTML 的文本
- **預期結果**: 乾淨的純文本

#### IC-UNIT-009: 並行處理測試
- **優先級**: P0
- **目的**: 驗證並行執行的正確性
- **輸入**: 多個並行任務
- **預期結果**: 所有任務正確完成，無競爭條件

#### IC-UNIT-010: TaskGroup 錯誤處理測試
- **優先級**: P1
- **目的**: 驗證 Python 3.11 TaskGroup 的錯誤處理
- **輸入**: 包含失敗任務的並行執行
- **預期結果**: ExceptionGroup 正確捕獲所有錯誤

### 2. 整合測試 (INT)

#### IC-INT-001: API 端點基本功能測試
- **優先級**: P0
- **目的**: 驗證 API 端點正常運作
- **輸入**: 有效的請求資料
- **預期結果**: 200 OK，返回正確格式的回應

#### IC-INT-002: 快取行為整合測試
- **優先級**: P0
- **目的**: 驗證快取在 API 層級的行為
- **輸入**: 相同請求多次調用
- **預期結果**: 第一次 cache miss，後續 cache hit

#### IC-INT-003: 輸入驗證測試
- **優先級**: P0
- **目的**: 驗證各種無效輸入的處理
- **輸入**: 空值、超長文本、無效格式
- **預期結果**: 400 Bad Request，適當的錯誤訊息

#### IC-INT-004: 外部服務失敗測試
- **優先級**: P0
- **目的**: 驗證 embedding 服務失敗的處理
- **輸入**: 模擬 Azure OpenAI 服務錯誤
- **預期結果**: 503 Service Unavailable

#### IC-INT-005: 並發請求測試
- **優先級**: P1
- **目的**: 驗證並發請求的處理
- **輸入**: 10 個同時的請求
- **預期結果**: 所有請求成功處理

#### IC-INT-006: 大文檔處理測試
- **優先級**: P1
- **目的**: 驗證大文檔的處理能力
- **輸入**: 50KB+ 的履歷和職缺描述
- **預期結果**: 成功處理，響應時間 < 5秒

#### IC-INT-007: 統計端點測試
- **優先級**: P2
- **目的**: 驗證服務統計資訊
- **輸入**: GET 請求到統計端點
- **預期結果**: 返回正確的統計資料

#### IC-INT-008: 跨語言測試
- **優先級**: P1
- **目的**: 驗證中英文混合內容
- **輸入**: 包含中英文的履歷和職缺
- **預期結果**: 正確處理，無亂碼

### 3. 效能測試 (PERF)

#### IC-PERF-001: 響應時間基準測試
- **優先級**: P0
- **目的**: 建立效能基準
- **輸入**: 標準測試資料集
- **預期結果**: P50 < 1秒，P95 < 2秒，P99 < 3秒

#### IC-PERF-002: 快取效能測試
- **優先級**: P0
- **目的**: 驗證快取的效能提升
- **輸入**: 重複的請求
- **預期結果**: Cache hit < 50ms

#### IC-PERF-003: 並發負載測試
- **優先級**: P0
- **目的**: 驗證系統在高負載下的表現
- **輸入**: 50 QPS 持續 5 分鐘
- **預期結果**: 成功率 > 95%，無記憶體洩漏

#### IC-PERF-004: 記憶體使用測試
- **優先級**: P1
- **目的**: 驗證記憶體使用效率
- **輸入**: 1000 個不同請求
- **預期結果**: 記憶體使用 < 2GB

#### IC-PERF-005: 快取大小限制測試
- **優先級**: P1
- **目的**: 驗證快取大小限制
- **輸入**: 超過快取限制的請求
- **預期結果**: 快取大小保持在限制內

### 4. 端對端測試 (E2E)

#### IC-E2E-001: 完整工作流程測試
- **優先級**: P0
- **目的**: 驗證完整的使用流程
- **輸入**: 真實的履歷和職缺資料
- **預期結果**: 正確的匹配分析結果

#### IC-E2E-002: 錯誤恢復測試
- **優先級**: P1
- **目的**: 驗證系統的錯誤恢復能力
- **輸入**: 各種錯誤場景
- **預期結果**: 系統能夠恢復，不影響後續請求

#### IC-E2E-003: 監控整合測試
- **優先級**: P2
- **目的**: 驗證監控資料的收集
- **輸入**: 各種操作
- **預期結果**: 監控系統正確記錄所有指標

## 測試資料集

### 標準測試資料
位於 `tests/fixtures/` 目錄：
- `standard_resumes.json` - 標準履歷集
- `standard_job_descriptions.json` - 標準職缺描述集
- `edge_cases.json` - 邊界案例資料

### 效能測試資料
- 小型文檔：< 1KB
- 中型文檔：1-10KB  
- 大型文檔：10-50KB
- 超大型文檔：> 50KB

## 測試環境要求

### 硬體要求
- CPU: 2 核心以上
- RAM: 4GB 以上
- 儲存: 10GB 可用空間

### 軟體要求
- Python 3.11.8
- Docker 20.10+
- pytest 7.4.0+
- 所有專案依賴

## 測試執行順序

1. 單元測試 (必須 100% 通過)
2. 整合測試 (必須 100% 通過)
3. 效能測試 (必須達到基準)
4. 端對端測試 (P0 必須通過)

## 測試報告要求

每次測試執行必須產生：
1. 測試覆蓋率報告
2. 測試結果摘要表
3. 效能指標報告
4. 失敗測試的詳細日誌

---

**文檔版本**: 1.0.0  
**建立日期**: 2025-08-02  
**最後更新**: 2025-08-02